package uk.ac.salford.cvefm.view 
{
	import fl.core.InvalidationType;
	import fl.motion.MotionEvent;
	import flash.automation.MouseAutomationAction;
	import flash.display.MovieClip;
	import flash.events.Event;
	import flash.events.MouseEvent;
	import flash.events.TouchEvent;
	import flash.geom.Matrix;
	import flash.text.TextField;
	import flash.ui.Multitouch;
	import flash.ui.MultitouchInputMode;
	import uk.ac.salford.cvefm.controller.PokerDataController;
	import uk.ac.salford.cvefm.model.BankData;
	import uk.ac.salford.cvefm.model.PokerPlayerData;
	
	/**
	 * ...
	 * @author Claire Miller
	 */
	public class BettingPanelView extends MovieClip
	{
		public static const NEXT_PLAYER:String = "BettingPanelView_NextPlayer";
		public static const PREVIOUS_PLAYER:String = "BettingPanelView_PreviousPlayer";
		
		public static const DEAL:String = "BettingPanelView_Deal";
		
		private var _data:PokerDataController;
		private var _bankData:BankData;
		private var _playerData:PokerPlayerData;
		
		private var _betText:TextField;
		private var _raiseText:TextField;
		private var _totalText:TextField;
		
		private var _panel:BettingPanelViewInstance;
		
		
		public function BettingPanelView(index:Number) 
		{	
			_data = PokerDataController.getInstance ()
			_bankData = _data.getBankData();
			_playerData = PokerDataController.getInstance ().getPokerPlayerData (index);
			
			this.addEventListener(Event.ADDED_TO_STAGE, initialise, false, 0, true);
		}
		
		public function initialise (event:Event) :void
		{
			_panel = new BettingPanelViewInstance ();
			addChild (_panel);
			
			var matrix:Matrix = _panel.transform.matrix;
			matrix.rotate(_playerData.panelRotation * Math.PI / 180);
			matrix.translate(_playerData.panelX, _playerData.panelY);
			
			_panel.transform.matrix = matrix;
			
			_panel.play_btn.visible = false;
			_panel.dealer_btn.visible = false;

			
			if (PokerDataController.getInstance ().touch)
			{
				setupTouch();
			}
			else
			{
				setupMouse();
			}
			
			_betText = _panel.bet_text;
			_totalText = _panel.total_text;
			
			updatePanel ();
		}
		
		private function setupTouch () :void
		{
			trace ("BettingPanelView::setupTouch");
			
			Multitouch.inputMode = MultitouchInputMode.TOUCH_POINT;
			
			// Add the listeners to the buttons			
			_panel.increase_button.addEventListener (TouchEvent.TOUCH_TAP, onIncreaseButton, false, 0, true);
			_panel.decrease_button.addEventListener (TouchEvent.TOUCH_TAP, onDecreaseButton, false, 0, true);
			
			//
			_panel.next_button.addEventListener (TouchEvent.TOUCH_TAP, onNextPlayer, false, 0, true);
			_panel.back_button.addEventListener (TouchEvent.TOUCH_TAP, onPreviousPlayer, false, 0, true);

			// 
			_panel.fold_button.addEventListener (TouchEvent.TOUCH_TAP, onFoldButton, false, 0, true);
			_panel.dealer_btn.addEventListener (TouchEvent.TOUCH_TAP, onDealButton, false, 0, true);
			
		}
		
		private function setupMouse () :void
		{
			trace ("BettingPanelView::setupMouse");
			
			// Add the listeners to the buttons			
			_panel.increase_button.addEventListener (MouseEvent.CLICK, onIncreaseButton, false, 0, true);
			_panel.decrease_button.addEventListener (MouseEvent.CLICK, onDecreaseButton, false, 0, true);
			
			//
			_panel.next_button.addEventListener (MouseEvent.CLICK, onNextPlayer, false, 0, true);
			_panel.back_button.addEventListener (MouseEvent.CLICK, onPreviousPlayer, false, 0, true);

			// 
			_panel.fold_button.addEventListener (MouseEvent.CLICK, onFoldButton, false, 0, true);
			_panel.dealer_btn.addEventListener (MouseEvent.CLICK, onDealButton, false, 0, true);
		}
		
		public function enable () :void
		{
			trace ("BettingPanelView::enable " + _playerData.playerId + " claiming:" + _data.claiming);
			if (_playerData.isActive || _data.claiming)
			{
				_panel.increase_button.visible = true;
				_panel.decrease_button.visible = true;
				
				_panel.next_button.visible = true;
				_panel.back_button.visible = true;
				
				_panel.fold_button.visible = true;
			}
			
			if (_data.claiming)
			{
				_panel.fold_button.visible = false;
			}
		}
		
		public function disable () :void
		{	
			//trace ("BettingPanelView::disable " + _playerData.playerId);
			
			_panel.increase_button.visible = false;
			_panel.decrease_button.visible = false;
			
			_panel.next_button.visible = false;
			_panel.back_button.visible = false;
			
			_panel.fold_button.visible = false;
			
			checkVisiblity();
		}
		
		public function setCurrentPlayer (value:Boolean) :void
		{
			_panel.play_btn.visible = value;
		}
		
		public function setCurrentDealer (value:Boolean) :void
		{
			_panel.dealer_btn.visible = value;
		}
		
		/**
		 * Complete the bet
		 */
		
		private function onFoldButton(e:MouseEvent) :void 
		{
			_playerData.bank ();
			_playerData.fold ();
			
			onNextPlayer (null);
		}
		
		private function onDealButton (e:MouseEvent) :void
		{
			dispatchEvent (new Event (DEAL));
		}
		
		/**
		 * Change the raise
		 */		
		private function onDecreaseButton(event:MouseEvent):void 
		{
			_playerData.decreaseRaise();
			_betText.text = _playerData.currentBet.toString();
		}
		
		private function onIncreaseButton(event:MouseEvent):void 
		{
			_playerData.increaseRaise();
			_betText.text = _playerData.currentBet.toString();
		}
		
		/**
		 * Move to the next player
		 * @param	event
		 */
		private function onNextPlayer (event:MouseEvent) :void
		{
			dispatchEvent (new Event (NEXT_PLAYER));
		}
		
		private function onPreviousPlayer (event:MouseEvent) :void
		{
			dispatchEvent (new Event (PREVIOUS_PLAYER));
		}
		
		public function updatePanel () :void
		{
			//trace ("BettingPanelView::completeRound " + _playerData.playerId);
			_betText.text = String(_playerData.currentBet);
			_totalText.text = String(_playerData.playersPotTotal);
			
			checkVisiblity ();
		}		
		
		private function checkVisiblity () :void
		{
			if (_playerData.isActive || _data.claiming)
			{
				_betText.visible = true;
				_panel.bet_txt_mc.visible = true;
			}
			else
			{
				_betText.visible = false;
				_panel.bet_txt_mc.visible = false;
			}
		}
	}

}