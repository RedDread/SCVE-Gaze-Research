package uk.ac.salford.cvefm.view 
{
	import fl.core.InvalidationType;
	import fl.motion.MotionEvent;
	import flash.automation.MouseAutomationAction;
	import flash.display.MovieClip;
	import flash.events.Event;
	import flash.events.MouseEvent;
	import flash.events.TouchEvent;
	import flash.geom.Matrix;
	import flash.text.TextField;
	import flash.ui.Multitouch;
	import flash.ui.MultitouchInputMode;
	import uk.ac.salford.cvefm.controller.PokerDataController;
	import uk.ac.salford.cvefm.model.BankData;
	import uk.ac.salford.cvefm.model.PlayerData;
	
	/**
	 * ...
	 * @author Claire Miller
	 */
	public class BettingPanelView extends MovieClip
	{
		public static const BET:String = "BettingPanelView_Bet";
		
		private var _isTouch:Boolean = false;
		
		private var _bankData:BankData;
		private var _playerData:PlayerData;
		
		private var _betText:TextField;
		private var _raiseText:TextField;
		private var _totalText:TextField;
		
		private var _panel:BettingPanelViewInstance;
		
		
		public function BettingPanelView(index:Number) 
		{
			_bankData = PokerDataController.getInstance ().getBankData();
			_playerData = PokerDataController.getInstance ().getPlayerData (index);
			_playerData.addEventListener (PlayerData.BANK, onUpdateText, false, 0, true);
			
			this.addEventListener(Event.ADDED_TO_STAGE, initialise, false, 0, true);
		}
		
		public function initialise (event:Event) :void
		{
			_panel = new BettingPanelViewInstance ();
			addChild (_panel);
			
			var matrix:Matrix = _panel.transform.matrix;
			matrix.rotate(_playerData.panelRotation * Math.PI / 180);
			matrix.translate(_playerData.panelX, _playerData.panelY);
			
			_panel.transform.matrix = matrix;
			
			_panel.play_btn.visible = false;
			_panel.dealer_btn.visible = false;
			
			_panel.claim_button.visible = false;
			
			if (_isTouch)
			{
				setupTouch();
			}
			else
			{
				setupMouse();
			}
			
			_betText = _panel.bet_text;
			_raiseText = _panel.raise_text;
			_totalText = _panel.total_text;
			
			onUpdateText (null);
		}
		
		public function nextGame () :void
		{
			_panel.claim_button.visible = false;
			onUpdateText (null);
		}
		
		private function setupTouch () :void
		{
			Multitouch.inputMode = MultitouchInputMode.TOUCH_POINT;
			
			//this.addEventListener (TouchEvent.TOUCH_TAP, onTouch, false, 0, true);
		}
		
		private function setupMouse () :void
		{
			// Add the listeners to the buttons			
			_panel.increase_button.addEventListener (MouseEvent.CLICK, onIncreaseButton, false, 0, true);
			_panel.decrease_button.addEventListener (MouseEvent.CLICK, onDecreaseButton, false, 0, true);
			
			//
			_panel.all_in_button .addEventListener (MouseEvent.CLICK, onAllInOneButton, false, 0, true);
			_panel.bet_button.addEventListener (MouseEvent.CLICK, onBetButton, false, 0, true); 
			_panel.check_call_button.addEventListener (MouseEvent.CLICK, onCheckCallButton, false, 0, true);
			_panel.fold_button.addEventListener (MouseEvent.CLICK, onFoldButton, false, 0, true);
			
			//
			_panel.claim_button.addEventListener (MouseEvent.CLICK, onClaimButton, false, 0, true);		
		}
		
		public function enable () :void
		{
			//trace ("BettingPanelView::enable " + _playerData.playerId);
			_panel.increase_button.visible = true;
			_panel.decrease_button.visible = true;
			
			_panel.all_in_button.visible = true;
			_panel.bet_button.visible = true;
			_panel.check_call_button.visible = true;
			_panel.fold_button.visible = true;
		}
		
		public function disable () :void
		{
			_panel.increase_button.visible = false;
			_panel.decrease_button.visible = false;
			
			_panel.all_in_button.visible = false;
			_panel.bet_button.visible = false;
			_panel.check_call_button.visible = false;
			_panel.fold_button.visible = false;
		}
		
		public function showClaimButton () :void
		{
			if (_playerData.isActive)
			{
				_panel.claim_button.visible = true
				_panel.play_btn.visible = false;
				disable ();
			}
		}
		
		public function setCurrentPlayer (value:Boolean) :void
		{
			_panel.play_btn.visible = value;
		}
		
		public function setCurrentDealer (value:Boolean) :void
		{
			_panel.dealer_btn.visible = value;
		}
		
		/**
		 * Complete the bet
		 */
		private function onBetButton (e:MouseEvent) :void 
		{
			_playerData.bet ();
			completeRound ();
		}
		
		private function onCheckCallButton(e:MouseEvent):void 
		{
			_playerData.callCheck ();
			completeRound ();
		}
		
		private function onFoldButton(e:MouseEvent):void 
		{
			_playerData.fold ();
			completeRound ();
		}
		
		private function onAllInOneButton(e:MouseEvent):void 
		{
			_playerData.allIn ();
			completeRound ();
		}
		
		/**
		 * Change the raise
		 */
		
		private function onDecreaseButton(event:MouseEvent):void 
		{
			_playerData.decreaseRaise();
			_raiseText.text = _playerData.currentRaise.toString();
		}
		
		private function onIncreaseButton(event:MouseEvent):void 
		{
			_playerData.increaseRaise();
			_raiseText.text = _playerData.currentRaise.toString();
		}
		
		/**
		 * Claim!
		 */
		
		private function onClaimButton (event:MouseEvent) :void
		{
			trace ("BettingPanelView::onClaimButton");
			_playerData.claimPot();
		}
		
		private function completeRound () :void
		{
			//trace ("BettingPanelView::completeRound " + _playerData.playerId);
			_betText.text = String(_playerData.currentBet);
			_raiseText.text = "0";
			_totalText.text = String(_playerData.playerTotal);
			
			dispatchEvent (new Event (BET, false));
		}
		
		private function onUpdateText (event:Event) :void
		{
			_betText.text = _playerData.currentBet.toString();
			_raiseText.text = _playerData.currentRaise.toString();
			_totalText.text = _playerData.playerTotal.toString();
		}
	}

}