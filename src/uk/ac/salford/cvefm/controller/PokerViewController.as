package uk.ac.salford.cvefm.controller 
{
	import flash.display.MovieClip;
	import flash.display.Sprite;
	import flash.events.Event;
	import flash.filters.ConvolutionFilter;
	import uk.ac.salford.cvefm.model.BankData;
	import uk.ac.salford.cvefm.model.CardData;
	import uk.ac.salford.cvefm.view.BettingPanelView;
	import uk.ac.salford.cvefm.view.PlayerView;
	import uk.ac.salford.cvefm.view.CommunityCardsView;
	import com.yahoo.astra.fl.managers.AlertManager;
	
	
	/**
	 * ...
	 * @author Claire Miller
	 */
	public class PokerViewController extends MovieClip
	{
		private var _data:PokerDataController;
		private var _blindsClock:BlindsClockContoller;
		private var _players:Array;
		private var _panels:Array;
		private var _communityCards:CommunityCardsView;
		private var _potView:PotViewInstance;
		private var _isHandEnd:Boolean;
		
		public function PokerViewController() 
		{			
			_data = PokerDataController.getInstance ();
			
			_data.addEventListener (PokerDataController.NEXT_HAND, onNextRound, false, 0, true);
			_data.addEventListener (PokerDataController.HAND_END, onHandEnd, false, 0, true);
			_data.addEventListener (PokerDataController.LOADED, onDataLoaded, false, 0, true);
			
			_data.addEventListener (PokerDataController.NO_MORE_ACTIVE_PLAYERS, onAlert, false, 0, true);
		}
		
		
		private function onDataLoaded (event:Event) :void
		{
			initialiseGame ();
			
			_data.getBankData ().addEventListener (BankData.POT_CLAIMED, onNextHand, false, 0, true);
		}
		
		
		public function initialiseGame () :void
		{
			// Add Blinds Clock
			_blindsClock = new BlindsClockContoller ();
			this.addChild (_blindsClock);
			
			// Add Players
			_players = new Array ();
			_panels = new Array ();
			
			for (var index:int = 0; index < PokerDataController.NUM_PLAYERS; index++) 
			{
				var player:PlayerView = new PlayerView (index); 			
				var bettingPanel:BettingPanelView = new BettingPanelView (index);
				
				this.addChild (player);
				this.addChild (bettingPanel);
				
				bettingPanel.addEventListener(BettingPanelView.BET, onPlayerBet, false, 0, true);
				
				_players.push (player);
				_panels.push (bettingPanel);
			}
			
			// Add Community Cards
			_communityCards = new CommunityCardsView ();
			this.addChild (_communityCards);
			
			// Add Pot View
			_potView = new PotViewInstance ();
			this.addChild (_potView);
			
			_potView.x = _data.potPoint.x;
			_potView.y = _data.potPoint.y;
			
			showCurrentPlayerControls ();
			setTheDealer ();
			
			onNextRound (null);
		}
		
		public function onAlert (event:Event) :void
		{
			AlertManager.createAlert (this, "GAME OVER: No more active players");
		}
		
		public function onNextHand (event:Event) :void
		{
			_isHandEnd = false;
			_communityCards.shuffle ();
			
			setTheDealer ();
			showCurrentPlayerControls ();
			
			trace ("PokerViewController::onNextHand display the new blinds");
			// Remove the cards and update the panels for new game
			for (var index:Number = 0; index < PokerDataController.NUM_PLAYERS; index++) 
			{
				_panels[index].nextGame();
				_players[index].nextGame();				
			}
			
			onNextRound (null);
		}
		
		private function showCurrentPlayerControls () :void
		{
			trace ("PokerViewController::showCurrentPlayerControls " + _data.currentPlayer);
			if (!_isHandEnd)
			{
				for (var index:Number = 0; index < PokerDataController.NUM_PLAYERS; index++) 
				{
					if (index == _data.currentPlayer)
					{
						_panels[index].enable ();
						_panels[index].setCurrentPlayer(true);				
					}
					else
						_panels[index].disable();
					{
						_panels[index].setCurrentPlayer(false);
					}
				}
			}
		}
		
		private function updatePot () :void
		{
			_potView.pot_total_text.text = _data.getBankData ().pot.toString ();
		}
		
		
		private function onPlayerBet (event:Event) :void
		{	
			trace ("PokerViewController::onPlayerBet");
			_data.moveToNextPlayer ();
			showCurrentPlayerControls ();
		}
		
		
		private function onNextRound (event:Event) :void
		{
			trace ("PokerViewController::onNextRound " + PokerDataController.GAME_STATES[_data.currentRound]);
			
			switch (PokerDataController.GAME_STATES[_data.currentRound])
			{
				case PokerDataController.BLINDS: break;
				case PokerDataController.PRE_FLOP:  dealCards(); break;
				case PokerDataController.FLOP:  _communityCards.flop(); break;
				case PokerDataController.TURN:	_communityCards.burnOneTurnOne(); break;
				case PokerDataController.RIVER:	_communityCards.burnOneTurnOne(); break;
			}
			
			updatePot ();			
		}
		
		private function setTheDealer() :void
		{
			// Set the dealer 
			for (var index:Number = 0; index < _panels.length; index++) 
			{
				_panels[index].setCurrentDealer(false);
			}
			_panels[_data.currentDealer].setCurrentDealer (true);
		}
		
		private function dealCards () :void
		{
			for (var index:Number = 0; index < _players.length; index++) 
			{
				if (_data.getPlayerData (index).playersPotTotal > 0)
				{
					PlayerView(_players[index]).dealTwoCards();
				}
			}
		}
		
		// End of the current game
		private function onHandEnd (event:Event) :void
		{
			trace ("PokerViewController::onHandEnd");
			_isHandEnd = true;
			for (var index:Number = 0; index < PokerDataController.NUM_PLAYERS; index++) 
			{
				_panels[index].disable ();
				_panels[index].showClaimButton ();
			}
			
			// If we've finished but not shown the cards, deal them all now
			if (_data.currentRound < PokerDataController.GAME_STATES.length)
			{
				switch (PokerDataController.GAME_STATES[_data.currentRound])
				{
//					case PokerDataController.BLINDS: break;  // CMTODO We're not doing this now so removing for now
					case PokerDataController.PRE_FLOP:  dealCards(); 
					case PokerDataController.FLOP:  _communityCards.flop(); 
					case PokerDataController.TURN:	_communityCards.burnOneTurnOne(); 
					case PokerDataController.RIVER:	_communityCards.burnOneTurnOne(); 
				}
			}
			
			updatePot ();
		}
	}

}