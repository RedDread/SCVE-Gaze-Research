package uk.ac.salford.cvefm.controller 
{
	import flash.display.MovieClip;
	import flash.display.Sprite;
	import flash.events.Event;
	import flash.events.MouseEvent;
	import flash.filters.ConvolutionFilter;
	import uk.ac.salford.cvefm.model.BankData;
	import uk.ac.salford.cvefm.model.CardData;
	import uk.ac.salford.cvefm.view.BettingPanelView;
	import uk.ac.salford.cvefm.view.PlayerView;
	import uk.ac.salford.cvefm.view.CommunityCardsView;
	import com.yahoo.astra.fl.managers.AlertManager;
	
	
	/**
	 * ...
	 * @author Claire Miller
	 */
	public class PokerViewController extends MovieClip
	{
		private var _data:PokerDataController;
		private var _blindsClock:BlindsClockContoller;
		private var _players:Array;
		private var _panels:Array;
		private var _communityCards:CommunityCardsView;
		private var _potView:PotViewInstance;
		private var _isHandEnd:Boolean;
		
		public function PokerViewController() 
		{			
			_data = PokerDataController.getInstance ();
			
			_data.addEventListener (PokerDataController.LOADED, onDataLoaded, false, 0, true);
			//_data.addEventListener (PokerDataController.NO_MORE_ACTIVE_PLAYERS, onAlert, false, 0, true);
		}
		
		
		private function onDataLoaded (event:Event) :void
		{
			initialiseGame ();
			
			//_data.getBankData ().addEventListener (BankData.POT_CLAIMED, onNextHand, false, 0, true);
		}
		
		
		public function initialiseGame () :void
		{
			// Add Blinds Clock
			_blindsClock = new BlindsClockContoller ();
			this.addChild (_blindsClock);
			
			// Add Players
			_players = new Array ();
			_panels = new Array ();
			
			for (var index:int = 0; index < PokerDataController.NUM_PLAYERS; index++) 
			{
				var player:PlayerView = new PlayerView (index); 			
				var bettingPanel:BettingPanelView = new BettingPanelView (index);
				
				this.addChild (player);
				this.addChild (bettingPanel);
				
				bettingPanel.addEventListener(BettingPanelView.NEXT_PLAYER, onNextPlayer, false, 0, true);
				bettingPanel.addEventListener(BettingPanelView.PREVIOUS_PLAYER, onPreviousPlayer, false, 0, true);
				bettingPanel.addEventListener(BettingPanelView.DEAL, onDealNextRound, false, 0, true);
				
				_players.push (player);
				_panels.push (bettingPanel);
			}
			
			// Add Community Cards
			_communityCards = new CommunityCardsView ();
			this.addChild (_communityCards);
			
			// Add Pot View
			_potView = new PotViewInstance ();
			this.addChild (_potView);
			
			_potView.x = _data.potPoint.x;
			_potView.y = _data.potPoint.y; 
			
			//_potView.deal_button.addEventListener (MouseEvent.CLICK, onDealNextRound, false, 0, true);
			_potView.claim_button.addEventListener (MouseEvent.CLICK, onClaim, false, 0, true);
			_potView.claim_button.visible = false;
			
			showCurrentPlayerControls ();
			setTheDealer ();
			
			dealCards ();
		}
		
		public function onAlert (event:Event) :void
		{
			AlertManager.createAlert (this, "GAME OVER: No more active players");
		}
		
		public function nextHand () :void
		{
			_communityCards.shuffle ();
			_data.nextHand ();
			
			setTheDealer ();
			showCurrentPlayerControls ();
			
			trace ("PokerViewController::onNextHand display the new blinds");
			// Remove the cards and update the panels for new game
			for (var index:Number = 0; index < PokerDataController.NUM_PLAYERS; index++) 
			{
				_players[index].nextGame ();				
				_panels[index].updatePanel ();
			}
		}
		
		private function showCurrentPlayerControls () :void
		{
			//trace ("PokerViewController::showCurrentPlayerControls " + _data.currentPlayer);

			for (var index:Number = 0; index < PokerDataController.NUM_PLAYERS; index++) 
			{
				if (index == _data.currentPlayer)
				{
					_panels[index].enable ();
					_panels[index].setCurrentPlayer(true);				
				}
				else
				{
					_panels[index].disable();				
					_panels[index].setCurrentPlayer(false);
				}
			}
		}
		
		private function updatePot () :void
		{
			_potView.pot_total_text.text = _data.getBankData ().pot.toString ();
		}
				
		private function onNextPlayer (event:Event) :void
		{	
			trace ("PokerViewController::onNextPlayer");
			_data.nextPlayer ();
			showCurrentPlayerControls ();
		}
		
		private function onPreviousPlayer (event:Event) :void
		{	
			trace ("PokerViewController::onPreviousPlayer");
			_data.previousPlayer ();
			showCurrentPlayerControls ();
		}
		
		private function onClaim (event:Event) :void
		{
			if (_data.playerClaimCorrect ())
			{
				_potView.claim_button.visible = false;
				
				dealNextRound ();
			}
		}
		
		private function onDealNextRound (event:Event) :void
		{
			trace ("PokerViewController::onDealNextRound");
			dealNextRound ();
		}
		
		private function dealNextRound () :void
		{
			_data.bankPlayerBets ();
			
			if (_data.claiming)
			{
				nextHand ();
			}
			
			trace ("PokerViewController::onDealNextRound " + PokerDataController.GAME_STATES[_data.currentRound]);
			switch (PokerDataController.GAME_STATES[_data.currentRound])
			{
				//case PokerDataController.BLINDS: nextHand (); break;
				case PokerDataController.PRE_FLOP:  dealCards();  break;
				case PokerDataController.FLOP:  _communityCards.flop(); break;
				case PokerDataController.TURN:	_communityCards.burnOneTurnOne(); break;
				case PokerDataController.RIVER:	_communityCards.burnOneTurnOne(); break;
				case PokerDataController.CLAIM: setupClaim(); break;
			}
			
			updatePot ();			
			updatePanels ();
		}
		
		private function setTheDealer() :void
		{
			// Set the dealer 
			for (var index:Number = 0; index < _panels.length; index++) 
			{
				_panels[index].setCurrentDealer(false);
			}
			_panels[_data.currentDealer].setCurrentDealer (true);
		}
		
		private function updatePanels () :void
		{
			// Set the dealer 
			for (var index:Number = 0; index < _panels.length; index++) 
			{
				_panels[index].updatePanel ();
			}
		}
		
		private function dealCards () :void
		{
			trace ("PokerViewController::dealCards");
			for (var index:Number = 0; index < _players.length; index++) 
			{
				if (_data.getPokerPlayerData (index).isActive)
				{
					PlayerView(_players[index]).dealTwoCards();
				}
			}
		}
		
		private function setupClaim () :void 
		{
			// Hide dealer button
			for (var index:Number = 0; index < _players.length; index++) 
			{
				BettingPanelView(_panels[index]).setCurrentDealer (false);
			}
			
			_potView.claim_button.visible = true;
			_data.claiming = true;
		}
	}

}