package uk.ac.salford.cvefm.controller 
{
	import flash.display.MovieClip;
	import flash.display.Sprite;
	import flash.events.Event;
	import flash.filters.ConvolutionFilter;
	import uk.ac.salford.cvefm.model.CardData;
	import uk.ac.salford.cvefm.view.PlayerView;
	import uk.ac.salford.cvefm.view.SharedCardsView;
	
	/**
	 * ...
	 * @author Claire Miller
	 */
	public class PokerViewController extends MovieClip
	{
		private var _data:PokerDataController;
		private var _players:Array;
		private var _sharedCards:SharedCardsView;
		
		public function PokerViewController() 
		{
			_data = PokerDataController.getInstance ();
			_data.addEventListener (PokerDataController.NEXT_ROUND, onNextRound);
			_data.addEventListener (PokerDataController.GAME_END, onEnd);
			_data.getCardData ().addEventListener (CardData.LOADED, onCardDataLoaded);
		}
		
		private function onCardDataLoaded (event:Event) :void
		{
			trace ("PokerViewController::onCardDataLoaded");
			initialiseGame ();
		}
		
		public function initialiseGame () :void
		{
			// Add Players
			_players = new Array ();
			
			for (var index:int = 0; index < PokerDataController.NUM_PLAYERS; index++) 
			{
				var player:PlayerView = new PlayerView (index);
				player.addEventListener (PlayerView.PLAYER_BET, onPlayerBet, false, 0, true);
				player.dealTwoCards ();
				
				this.addChild (player);
				_players.push (player);
			}
			
			// Add Shared View
			_sharedCards = new SharedCardsView ();
			this.addChild (_sharedCards);
			
			swapPlayers ();
		}
		
		private function swapPlayers () :void
		{
			trace ("PokerViewController::swapPlayers " + _data.currentPlayer);
			for (var index:Number = 0; index < PokerDataController.NUM_PLAYERS; index++) 
			{
				if (index == _data.currentPlayer)
				{
					_players[index].enable ();
				}
				else
				{
					_players[index].disable();
				}
			}
		}
		
		private function onPlayerBet (event:Event) :void
		{
			_data.moveToNextPlayer ();
			swapPlayers ();
			
			// CMTODO - move the button to show who's go it is
		}
		
		private function onNextRound (event:Event) :void
		{
			trace ("PokerViewController::onNextRound " + PokerDataController.GAME_STATES[_data.currentRound]);
			switch (PokerDataController.GAME_STATES[_data.currentRound])
			{
				case PokerDataController.PRE_FLOP: throw new Error ("Shouldn't be pre-flopping");
				case PokerDataController.FLOP:	_sharedCards.flop(); break;
				case PokerDataController.TURN:	_sharedCards.burnOneTurnOne(); break;
				case PokerDataController.RIVER:	_sharedCards.burnOneTurnOne(); break;
			}
		}
		
		private function onEnd (event:Event) :void
		{
			for (var index:Number = 0; index < PokerDataController.NUM_PLAYERS; index++) 
			{
				_players[index].disable();
			}
			
			// CMTODO show end screen
		}
	}

}