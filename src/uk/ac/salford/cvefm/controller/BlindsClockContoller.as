package uk.ac.salford.cvefm.controller 
{
	import flash.display.MovieClip;
	import flash.events.Event;
	import flash.events.TimerEvent;
	import flash.utils.Timer;
	import uk.ac.salford.cvefm.model.BankData;
	import uk.ac.salford.cvefm.view.BlindsClockView;
	import com.yahoo.astra.fl.managers.AlertManager;
	
	/**
	 * ...
	 * @author Claire Miller
	 */
	public class BlindsClockContoller extends MovieClip
	{
		private var _clock:Timer;
		private var _bankData:BankData;
		private var _blindsClockView:BlindsClockView;
		
		public function BlindsClockContoller() 
		{	
			_bankData = PokerDataController.getInstance ().getBankData();
			_bankData.addEventListener (BankData.NO_MORE_BLINDS, onAlert, false, 0, true);
			
			_clock = new Timer (1000, 0);
			_clock.addEventListener (TimerEvent.TIMER, onClockTick, false, 0, true);
			_clock.start ();
			
			_blindsClockView = new BlindsClockView ();
			
			this.addChild (_blindsClockView);
		}
		
		private function onAlert (event:Event) :void
		{
			stopClock ();
			AlertManager.createAlert (this, "GAME OVER: No more Blinds, last hand!");
		}
		
		public function onClockTick (event:TimerEvent) :void
		{
			var countdown:Number = (_bankData.blindInterval - (_clock.currentCount % _bankData.blindInterval)) - 1;
			
			if (countdown == 0)
			{
				_bankData.incrementBlinds ();
				_blindsClockView.setBlinds();
			}
			
			var time:String = formatTime (countdown, MINUTES);
			
			_blindsClockView.setBlindsClock (time);
		}
		
		public function stopClock () :void
		{
			_clock.stop ();
		}
		/*
		public function stop ()
		{
		}
		
		public function reset ()
		{	
		}
		*/
		
		public static const HOURS:uint = 2;
		public static const MINUTES:uint = 1;
		public static const SECONDS:uint = 0;

		private function formatTime (time:Number, detailLevel:uint = 2):String 
		{
			var intTime:uint = Math.floor(time);
			var hours:uint = Math.floor(intTime/ 3600);
			var minutes:uint = (intTime - (hours*3600))/60;
			var seconds:uint = intTime -  (hours*3600) - (minutes * 60);
			var hourString:String = detailLevel == HOURS ? hours + ":":"";
			var minuteString:String = detailLevel >= MINUTES ? ((detailLevel == HOURS && minutes <10 ? "0":"") + minutes + ":"):"";
			var secondString:String = ((seconds < 10 && (detailLevel >= MINUTES)) ? "0":"") + seconds;
			return hourString + minuteString + secondString;
		}
	}

}