package uk.ac.salford.cvefm.model 
{
	import flash.events.Event;
	import flash.events.EventDispatcher;
	import flashandmath.as3.cards.CardLoader;
	import flashandmath.as3.cards.PlayingCard;
	
	/**
	 * Extracted from flash and math example
	 * @author Claire Miller
	 */
	public class CardData extends EventDispatcher
	{
		public static const LOADED:String = "CardLoaded_Loaded";
		public static const ERROR:String = "CardLoaded_Error";
		
		private var _cardLoader:CardLoader;
		private var _deck:Array;  //Shuffled cards in play
		
		
		public function CardData ()
		{
			loadCards ();
		}
		
		public function shuffle () :void
		{
			if (_deck)
			{
				// CMTODO Check this clears everything up properly
				_deck = null;
			}
			
			_deck = new Array (52);
			
			// _deck is initially empty. _cards is initially the array of 
			//   PlayingCard objects from the CardLoader object cardLdr
			var cards:Array = new Array (52);
			cards = (_cardLoader.getCardArray()).concat ();
			
			var random:Number;
			var pc:PlayingCard;
			
			// Remove random cards from _cards and place them on _deck. 
			//   Each is set to be initially facedown.
			for (var index:Number = 0; index < 52; index++) 
			{
				random = Math.floor (cards.length * Math.random());
				pc = cards.splice (random, 1)[0] as PlayingCard;
				
				/*
				pc.makeFaceDown();
				pc.transform.perspectiveProjection = pp;
				//board.addChild(pc);
				*/
				
				// Position each card
				pc.x = 0;
				pc.y = 0;
				pc.z = 0;
				
				_deck[index] = pc;
			}
		}
		
		public function getNextCard () :PlayingCard
		{
			return _deck.splice(_deck.length - 1,1)[0];
				//board.setChildIndex(topCard,board.numChildren-1);
		}
		
		private function loadCards () :void 
		{
			trace ("CardData::loadCards");
			var arrVals:Array = ["A","2","3","4","5","6","7","8","9","T","J","Q","K"];
			var arrSuits:Array = ["C","H","S","D"];
			var _cardstrings:Array = new Array (52);
			var i:int, j:int;
			
			// Fill _cardstrings with the 52 file names for the card faces
			for (i = 0; i < 4; i++) 
			{
				for (j=0; j<13; j++) {
					_cardstrings[13*i+j] = "cards/"+arrVals[j]+arrSuits[i]+"-150.png";
				}
			}
			
			/* 
			CardLoader object is constructed with an array of file names of card faces 
			and a single file name for the card back
			*/
			_cardLoader = new CardLoader (_cardstrings, "cards/redback3-150.png");
			
			_cardLoader.addEventListener (CardLoader.CARDS_LOADED, onLoadComplete, false, 0, true);
			_cardLoader.addEventListener (CardLoader.LOAD_ERROR, onLoadError, false, 0, true);
		}

		// Called when all card image files have completely loaded. Primarily calls the setupDeck function, defined further below.
		private function onLoadComplete(e:Event):void 
		{
			trace ("CardData::onLoadComplete");
			
			shuffle ();
			
			_cardLoader.removeEventListener (CardLoader.CARDS_LOADED, onLoadComplete);
			_cardLoader.removeEventListener (CardLoader.LOAD_ERROR, onLoadError);
			
			// Card loaded
			dispatchEvent (new Event (CardData.LOADED));
		}

		// Actions to take if there is a file error
		private function onLoadError (e:Event) :void 
		{
			trace ("CardData::onLoadError " + e.toString ());
			_cardLoader.removeEventListener(CardLoader.CARDS_LOADED, onLoadComplete);
			_cardLoader.removeEventListener(CardLoader.LOAD_ERROR, onLoadError);
			
			dispatchEvent (new Event (CardData.ERROR));
		}
	}
}
