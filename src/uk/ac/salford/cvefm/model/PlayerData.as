package uk.ac.salford.cvefm.model 
{
	import flash.events.Event;
	import flash.events.EventDispatcher;
	import uk.ac.salford.cvefm.controller.PokerDataController;
	/**
	 * ...
	 * @author Claire Miller
	 */
	public class PlayerData extends EventDispatcher
	{
		public static const BET_CHANGED:String = "PlayerData_BetChanged"
		public static const BANK:String = "PlayerData_Bank"
		
		public static const FOLD:String = "Fold"
		public static const ALL_IN:String = "All_In"
		public static const CHECK_BET:String = "Check_Bet"
		public static const RAISE:String = "Raise"
		
		private var _cardX:Number;
		private var _cardY:Number;
		private var _cardRotation:Number;
		
		private var _panelX:Number;
		private var _panelY:Number;
		private var _panelRotation:Number;
		
		private var _playerTotal:Number;
		private var _currentBet:Number;	
		private var _currentRaise:Number;
		
		private var _isActive:Boolean;
		
		private var _bankData:BankData;

		
		public function PlayerData (xml:XML)
		{
			_cardX = xml.card.@x;
			_cardY = xml.card.@y;
			_cardRotation = xml.card.@rotation;
			
			_panelX = xml.panel.@x;
			_panelY = xml.panel.@y;
			_panelRotation = xml.panel.@rotation;
			
			_playerTotal = xml.@starting_pot;
			
			_isActive = true;
			_currentBet = _currentRaise = 0;
			_bankData = PokerDataController.getInstance ().getBankData();
		}
		
		public function get cardX():Number { return _cardX; }
		public function get cardY():Number { return _cardY; }
		public function get cardRotation():Number { return _cardRotation; }
		
		public function get panelX():Number { return _panelX; }
		public function get panelY():Number { return _panelY; }
		public function get panelRotation():Number { return _panelRotation; }
		
		public function get playerTotal():Number { return _playerTotal; }
		public function get currentRaise():Number { return _currentRaise; }
		public function set currentRaise(raiseValue:Number) :void { _currentRaise = raiseValue; }
		public function get currentBet():Number { return _currentBet; }
		public function set currentBet(betValue:Number) :void { _currentBet = betValue; }
		
		/**
		 * Bank the players cash at the end of the round
		 * @return
		 */
		public function bank () :void
		{
			_playerTotal -= _currentBet;
			_bankData.addToPot (_currentBet);
			
			_currentBet = 0;
			_currentRaise = 0;
			_isActive = true;
			
			dispatchEvent (new Event (BANK, false));
		}
		
		/**
		 * All functions return the current bet value
		 */
		public function check () :void
		{
			// CMTODO - Probably need some more logic here
			if (_currentBet != _bankData.lastBet)
			{
				throw new Error ("PlayerData::Check - You need to match the bet");
			}
		}
			
		//7. The Minimum bet/raise is equal to the BB. Any re-raise must be equal or greater than the previous raise.
		public function bet () :void
		{
			if (_currentRaise < _bankData.lastRaise)
			{
				throw new Error ("PlayerData::Check - You need to double the raise");
			}
			_currentBet += _currentRaise;
			
			dispatchEvent (new Event (BET_CHANGED, false));
		}
		
		public function call () :void
		{
			_currentBet = _bankData.lastBet;
			
			// Check that we have enough to call
			if (_currentBet > _playerTotal)
			{
				throw new Error ("PlayerData::Check - You need to have enough money to call");
			}
		}
		
		public function allIn () :void
		{
			_currentBet = _playerTotal;
		}
		
		public function fold () :void
		{
			_isActive = false;
		}
		
	
		/**
		 * These change the raise values
		 */
		
		public function increaseRaise () :void
		{
			// Only allow increase to player total
			if (_currentRaise + _currentBet +  _bankData.lastRaise < _playerTotal)
			{
				_currentRaise += _bankData.lastRaise;
			}
		}
		
		public function decreaseRaise () :void
		{
			_currentRaise -= _bankData.lastRaise;
			
			// Only allow to decrease to the last raise
			if (_currentRaise < _bankData.lastRaise)
			{
				_currentRaise == _bankData.lastRaise;
			}
		}
		
	}

}